{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js", "../../@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],
  "sourcesContent": ["/*\r\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\r\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\r\n*/\r\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\r\n", "/*\r\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\r\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\r\n*/\r\nimport e from\"../../../geometry/Point.js\";import n from\"./EphemeralBlockCache.js\";import{projectExtent as t,projectResolution as o,snapPyramid as l}from\"../rasterFunctions/rasterProjectionHelper.js\";const r=new Map,c=new n;function i(e,n,t){const o=[];return null!=n&&o.push(`sliceId=${n}`),null!=t&&o.push(`bandIds=${t.join(\",\")}`),o.length?`${e}?${o.join(\"&\")}`:e}function u(e,n){const t={extent:null,rasterInfo:n,cache:new Map},o=r.get(e);return o?(o.push(t),o.length-1):(r.set(e,[t]),0)}function a(e,n){const t=r.get(e);t&&(t[n]=null,t.some((e=>null!=e))||r.delete(e))}function f(e){r.delete(e)}function s(e,n,t){const o=r.get(e);if(!o)return null==n?c.decreaseRefCount(e,t):0;if(null==n||null==o[n])return c.decreaseRefCount(e,t);const l=o[n]?.cache,i=l?.get(t);if(l&&i){if(i.refCount--,0===i.refCount){l.delete(t);for(let e=0;e<o.length;e++)o[e]?.cache.delete(t);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,n,t){const o=r.get(e);if(!o)return null==n?c.getBlock(e,t):null;if(null==n||null==o[n]){for(let e=0;e<o.length;e++){const n=o[e]?.cache.get(t);if(n)return n.refCount++,n.block}return c.getBlock(e,t)}const l=o[n]?.cache.get(t);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===n||!o[r])continue;const e=o[r]?.cache,l=e?.get(t);if(e&&l)return l.refCount++,e.set(t,l),l.block}return null}function h(e,n,t,o,l=null){const i=r.get(e);if(!i)return void(null==n&&c.putBlock(e,t,o,l));if(null==n||null==i[n])return void c.putBlock(e,t,o,l);const u={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then((()=>u.isResolved=!0)).catch((()=>u.isRejected=!0)),i[n]?.cache.set(t,u)}function x(e,n,t){const o=r.get(e);o?null!=n&&null!=o[n]?o[n]?.cache.delete(t):c.deleteBlock(e,t):null==n&&c.deleteBlock(e,t)}function d(e,n){const t=r.get(e);return t?t[n]??null:null}function g(n,r,c,i,u,a,f=null){const s=d(n,r);if(!s)return;const m=s.extent,{cache:h,rasterInfo:x}=s;if(m&&m.xmin===c.xmin&&m.xmax===c.xmax&&m.ymin===c.ymin&&m.ymax===c.ymax)return;i=i??0;const g=c.clone().normalize(),{spatialReference:p,transform:y}=x,k=new Set;for(let d=0;d<g.length;d++){const n=g[d];if(n.xmax-n.xmin<=i||n.ymax-n.ymin<=i)continue;let r=t(n,p,f);if(null==r)continue;if(null!=y&&(r=y.inverseTransform(r),null==r))continue;const c=new e({x:i,y:i,spatialReference:n.spatialReference});if(null==u&&!(u=o(c,p,n,f)))return;const{pyramidLevel:s,pyramidResolution:m,excessiveReading:h}=l(u,x,a||\"closest\");if(h)return;const{storageInfo:M}=x,{origin:R}=M,{x:C,y:B}=m,b=Math.max(0,Math.floor((r.xmin-R.x)/C)),j=Math.max(0,Math.floor((R.y-r.ymax)/B)),v=Math.ceil(r.width/C-.1),w=Math.ceil(r.height/B-.1),$=s>0?M.pyramidBlockWidth:M.blockWidth,I=s>0?M.pyramidBlockHeight:M.blockHeight,H=M.blockBoundary[s];if(!H)continue;const E=1,P=Math.max(H.minCol,Math.floor(b/$)-E),W=Math.max(H.minRow,Math.floor(j/I)-E),z=Math.min(H.maxCol,Math.floor((b+v-1)/$)+E),F=Math.min(H.maxRow,Math.floor((j+w-1)/I)+E);for(let e=W;e<=F;e++)for(let n=P;n<=z;n++)k.add(`${s}/${e}/${n}`)}h.forEach(((e,n)=>{if(!k.has(n)){const e=h.get(n);(null==e||e.isResolved||e.isRejected)&&h.delete(n)}})),s.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}export{s as decreaseRefCount,x as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,h as putBlock,u as register,a as unregister,g as update};\r\n"],
  "mappings": "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",
  "names": ["t", "s", "r", "i", "c", "t", "e", "t", "i", "e", "n", "r", "l", "u", "c", "a", "s", "m", "h", "x", "g", "d", "_"]
}
