{
  "version": 3,
  "sources": ["../../@arcgis/core/views/3d/webgl-engine/core/shaderLibrary/shading/WaterDistortion.glsl.js", "../../@arcgis/core/chunks/WaterSurface.glsl.js"],
  "sourcesContent": ["/*\r\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\r\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\r\n*/\r\nimport{set as e}from\"../../../../../../core/libs/gl-matrix-2/math/vec2.js\";import{create as t}from\"../../../../../../core/libs/gl-matrix-2/factories/vec2f64.js\";import{s as r}from\"../../../../../../chunks/vec42.js\";import{create as a}from\"../../../../../../core/libs/gl-matrix-2/factories/vec4f64.js\";import{FoamIntensity as o}from\"./FoamRendering.glsl.js\";import{ReadShadowMapPassParameters as m}from\"./ReadShadowMap.glsl.js\";import{Float2PassUniform as s}from\"../../shaderModules/Float2PassUniform.js\";import{Float4PassUniform as v}from\"../../shaderModules/Float4PassUniform.js\";import{glsl as l}from\"../../shaderModules/glsl.js\";import{Texture2DPassUniform as i}from\"../../shaderModules/Texture2DPassUniform.js\";function u(t){t.fragment.uniforms.add(new i(\"texWaveNormal\",(e=>e.waveNormal)),new i(\"texWavePerturbation\",(e=>e.wavePerturbation)),new v(\"waveParams\",(e=>r(c,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset))),new s(\"waveDirection\",(t=>e(n,t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)))),t.fragment.include(o),t.fragment.code.add(l`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\r\nvec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\r\nreturn 2.0 * texture(_tex, _uv).rg - 1.0;\r\n}\r\nfloat sampleNoiseTexture(vec2 _uv) {\r\nreturn texture(texWavePerturbation, _uv).b;\r\n}\r\nvec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\r\nreturn 2.0 * texture(_tex, _uv).rgb - 1.0;\r\n}\r\nfloat computeProgress(vec2 uv, float time) {\r\nreturn fract(time);\r\n}\r\nfloat computeWeight(vec2 uv, float time) {\r\nfloat progress = computeProgress(uv, time);\r\nreturn 1.0 - abs(1.0 - 2.0 * progress);\r\n}\r\nvec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\r\nfloat flowStrength = waveParams[2];\r\nfloat flowOffset = waveParams[3];\r\nvec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\r\nfloat progress = computeProgress(uv, time + phaseOffset);\r\nfloat weight = computeWeight(uv, time + phaseOffset);\r\nvec2 result = uv;\r\nresult -= flowVector * (progress + flowOffset);\r\nresult += phaseOffset;\r\nresult += (time - progress) * FLOW_JUMP;\r\nreturn vec3(result, weight);\r\n}\r\nconst float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\r\nconst float TIME_NOISE_STRENGTH = 7.77;\r\nvec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\r\nfloat waveStrength = waveParams[0];\r\nvec2 waveMovement = time * -_waveDir;\r\nfloat timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\r\nvec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\r\nvec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\r\nvec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\r\nvec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\r\nvec3 mixNormal = normalize(normal_A + normal_B);\r\nmixNormal.xy *= waveStrength;\r\nmixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\r\nreturn mixNormal;\r\n}\r\nvec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\r\nfloat waveTextureRepeat = waveParams[1];\r\nvec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\r\nfloat foam  = normals2FoamIntensity(normal, waveParams[0]);\r\nreturn vec4(normal, foam);\r\n}`)}class f extends m{}const c=a(),n=t();export{u as WaterDistortion,f as WaterDistortionPassParameters};\r\n", "/*\r\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\r\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\r\n*/\r\nimport{ForwardLinearDepth as e}from\"../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl.js\";import{isColorOrColorEmission as r,ShaderOutput as i}from\"../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput.js\";import{SliceDraw as o}from\"../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl.js\";import{Transform as a}from\"../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl.js\";import{ObjectAndLayerIdColor as t}from\"../views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl.js\";import{OutputHighlight as n}from\"../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl.js\";import{EvaluateAmbientLighting as s}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientLighting.glsl.js\";import{addMainLightDirection as l,addMainLightIntensity as d}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl.js\";import{NormalUtils as g}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/NormalUtils.glsl.js\";import{PBRMode as m}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl.js\";import{ReadShadowMapDraw as c}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl.js\";import{terrainDepthTest as v}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl.js\";import{Water as p}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/Water.glsl.js\";import{WaterDistortion as w}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/WaterDistortion.glsl.js\";import{ColorConversion as u}from\"../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl.js\";import{addProjViewLocalOrigin as f,addCameraPosition as h}from\"../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl.js\";import{Float4PassUniform as b}from\"../views/3d/webgl-engine/core/shaderModules/Float4PassUniform.js\";import{FloatPassUniform as y}from\"../views/3d/webgl-engine/core/shaderModules/FloatPassUniform.js\";import{glsl as j}from\"../views/3d/webgl-engine/core/shaderModules/glsl.js\";import{VertexAttribute as L}from\"../views/3d/webgl-engine/lib/VertexAttribute.js\";import{outputColorHighlightOID as C}from\"../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl.js\";import{ShaderBuilder as P}from\"../views/webgl/ShaderBuilder.js\";import{alphaCutoff as x}from\"../webscene/support/AlphaCutoff.js\";function O(O){const S=new P,{vertex:D,fragment:N,varyings:_}=S,{output:F,draped:M,receiveShadows:z}=O;f(D,O),S.include(a,O),S.attributes.add(L.POSITION,\"vec3\"),S.attributes.add(L.UV0,\"vec2\");const A=new b(\"waterColor\",(e=>e.color));if(_.add(\"vpos\",\"vec3\",{invariant:!0}),D.uniforms.add(A),r(F)){if(M)return D.main.add(j`\r\n      if (waterColor.a < ${j.float(x)}) {\r\n        // Discard this vertex\r\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\r\n        return;\r\n      }\r\n\r\n      vpos = position;\r\n      gl_Position = transformPosition(proj, view, vpos);`),N.uniforms.add(A),N.main.add(j`fragColor = waterColor;`),S;S.include(g,O),S.include(e,O),_.add(\"vuv\",\"vec2\"),_.add(\"vnormal\",\"vec3\"),_.add(\"vtbnMatrix\",\"mat3\"),D.main.add(j`\r\n      if (waterColor.a < ${j.float(x)}) {\r\n        // Discard this vertex\r\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\r\n        return;\r\n      }\r\n\r\n      vuv = uv0;\r\n      vpos = position;\r\n\r\n      vnormal = getLocalUp(vpos, localOrigin);\r\n      vtbnMatrix = getTBNMatrix(vnormal);\r\n      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);\r\n\r\n      gl_Position = transformPosition(proj, view, vpos);\r\n      forwardLinearDepth();`)}switch(S.include(v,O),F){case i.Color:case i.ColorEmission:S.include(s,{pbrMode:m.Disabled,lightingSphericalHarmonicsOrder:2}),S.include(w),S.include(c,O),S.include(p,O),N.include(o,O),S.include(C,O),N.include(u),h(N,O),l(N),d(N),N.uniforms.add(A,new y(\"timeElapsed\",(({timeElapsed:e})=>e)),D.uniforms.get(\"view\"),D.uniforms.get(\"localOrigin\")).main.add(j`\r\n        discardBySlice(vpos);\r\n        discardByTerrainDepth();\r\n        vec3 localUp = vnormal;\r\n        // the created normal is in tangent space\r\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\r\n\r\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\r\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\r\n        vec3 v = -normalize(vpos - cameraPosition);\r\n        float shadow = ${z?j`1.0 - readShadowMap(vpos, linearDepth)`:\"1.0\"};\r\n        vec4 vPosView = view * vec4(vpos, 1.0);\r\n        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);\r\n\r\n        // gamma correction\r\n        fragColor = delinearizeGamma(final);\r\n        outputColorHighlightOID(fragColor, vpos, final.rgb);`);break;case i.Normal:S.include(g,O),S.include(w,O),N.include(o,O),_.add(\"vuv\",\"vec2\"),D.main.add(j`\r\n        if (waterColor.a < ${j.float(x)}) {\r\n          // Discard this vertex\r\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\r\n          return;\r\n        }\r\n\r\n        vuv = uv0;\r\n        vpos = position;\r\n\r\n        gl_Position = transformPosition(proj, view, vpos);`),N.uniforms.add(new y(\"timeElapsed\",(({timeElapsed:e})=>e))).main.add(j`discardBySlice(vpos);\r\nvec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\r\ntangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\r\nfragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);`);break;case i.Highlight:S.include(n,O),D.main.add(j`\r\n        if (waterColor.a < ${j.float(x)}) {\r\n          // Discard this vertex\r\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\r\n          return;\r\n        }\r\n\r\n        vpos = position;\r\n        gl_Position = transformPosition(proj, view, vpos);`),N.include(o,O),N.main.add(j`discardBySlice(vpos);\r\ncalculateOcclusionAndOutputHighlight();`);break;case i.ObjectAndLayerIdColor:S.include(t,O),D.main.add(j`\r\n        if (waterColor.a < ${j.float(x)}) {\r\n          // Discard this vertex\r\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\r\n          return;\r\n        }\r\n\r\n        vpos = position;\r\n        gl_Position = transformPosition(proj, view, vpos);\r\n        forwardObjectAndLayerIdColor();`),N.include(o,O),N.main.add(j`discardBySlice(vpos);\r\noutputObjectAndLayerIdColor();`)}return S}const S=Object.freeze(Object.defineProperty({__proto__:null,build:O},Symbol.toStringTag,{value:\"Module\"}));export{S as W,O as b};\r\n"],
  "mappings": "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",
  "names": ["u", "t", "s", "e", "n", "n", "O", "S", "o", "e", "n", "i", "u", "m", "d", "s"]
}
