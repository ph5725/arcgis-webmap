{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/mixins/PortalLayer.js"],
  "sourcesContent": ["/*\r\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\r\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\r\n*/\r\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../config.js\";import{id as r}from\"../../kernel.js\";import s from\"../../request.js\";import{result as i}from\"../../core/asyncUtils.js\";import o from\"../../core/Error.js\";import a from\"../../core/Logger.js\";import{destroyMaybe as l}from\"../../core/maybe.js\";import{throwIfAborted as n,isAbortError as p,throwIfAbortError as u}from\"../../core/promiseUtils.js\";import{hasSameCanonicalPortal as c,hasSamePortal as d,normalize as m}from\"../../core/urlUtils.js\";import{property as h}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/RandomLCG.js\";import{reader as f}from\"../../core/accessorSupport/decorators/reader.js\";import{subclass as g}from\"../../core/accessorSupport/decorators/subclass.js\";import{writer as y}from\"../../core/accessorSupport/decorators/writer.js\";import{getOwningPortalUrl as I}from\"../support/layerUtils.js\";import v from\"../../portal/Portal.js\";import P from\"../../portal/PortalItem.js\";import U from\"../../portal/PortalUser.js\";import{getUserPrivileges as w}from\"../../portal/support/portalItemUtils.js\";const j=j=>{let E=class extends j{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=l(this.portalItem),this.resourceReferences.portalItem=null,this.resourceReferences.paths.length=0}set portalItem(e){e!==this._get(\"portalItem\")&&(this.removeOrigin(\"portal-item\"),this._set(\"portalItem\",e))}readPortalItem(e,t,r){if(t.itemId)return new P({id:t.itemId,portal:r?.portal})}writePortalItem(e,t){e?.id&&(t.itemId=e.id)}async loadFromPortal(e,t){if(this.portalItem?.id)try{const{load:r}=await import(\"../../portal/support/layersLoader.js\");return n(t),await r({instance:this,supportedTypes:e.supportedTypes,validateItem:e.validateItem,supportsData:e.supportsData,layerModuleTypeMap:e.layerModuleTypeMap,populateGroupLayer:e.populateGroupLayer},t)}catch(r){throw p(r)||a.getLogger(this).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\\n  ${r}`),r}}async finishLoadEditablePortalLayer(e){this._set(\"userHasEditingPrivileges\",await this._fetchUserHasEditingPrivileges(e).catch((e=>(u(e),!0))))}async setUserPrivileges(e,r){if(!t.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(r);if(this.url)try{const{features:{edit:t,fullEdit:s},content:{updateItem:i}}=await this._fetchUserPrivileges(e,r);this._set(\"userHasEditingPrivileges\",t),this._set(\"userHasFullEditingPrivileges\",s),this._set(\"userHasUpdateItemPrivileges\",i)}catch(s){u(s)}}async _fetchUserPrivileges(e,t){let s=this.portalItem;if(!e||!s||!s.loaded||s.sourceUrl)return this._fetchFallbackUserPrivileges(t);const i=!r?.findCredential(this.url),o=e===s.id;if(o&&s.portal.user)return this._getUserPrivileges(s,i);let a,l;if(o)a=s.portal.url;else try{a=await I(this.url,t)}catch(m){u(m)}if(!a||!c(a,s.portal.url))return this._fetchFallbackUserPrivileges(t);try{const e=null!=t?t.signal:null;l=await(r?.getCredential(`${a}/sharing`,{prompt:!1,signal:e}))}catch(m){u(m)}const n=!0,p=!1,d=!1;if(!l)return{features:{edit:n,fullEdit:p},content:{updateItem:d}};try{if(o?await s.reload():(s=new P({id:e,portal:{url:a}}),await s.load(t)),s.portal.user)return this._getUserPrivileges(s,i)}catch(m){u(m)}return{features:{edit:n,fullEdit:p},content:{updateItem:d}}}_getUserPrivileges(e,t){const r=w(e);return t&&(r.features.edit=!0),r}async _fetchFallbackUserPrivileges(e){let t=!0;try{t=await this._fetchUserHasEditingPrivileges(e)}catch(r){u(r)}return{features:{edit:t,fullEdit:!1},content:{updateItem:!1}}}async _fetchUserHasEditingPrivileges(e){const t=this.url?r?.findCredential(this.url):null;if(!t)return!0;const s=_.credential===t?_.user:await this._fetchEditingUser(e);return _.credential=t,_.user=s,null==s?.privileges||s.privileges.includes(\"features:user:edit\")}async _fetchEditingUser(e){const t=this.portalItem?.portal?.user;if(t)return t;const o=r?.findServerInfo(this.url??\"\");if(!o?.owningSystemUrl)return null;const a=`${o.owningSystemUrl}/sharing/rest`,l=v.getDefault();if(l&&l.loaded&&m(l.restUrl)===m(a))return l.user;const n=`${a}/community/self`,p=null!=e?e.signal:null,u=await i(s(n,{authMode:\"no-prompt\",query:{f:\"json\"},signal:p}));return u.ok?U.fromJSON(u.value.data):null}read(e,t){t&&(t.layer=this),super.read(e,t)}write(e,t){const r=t?.portal,s=this.portalItem?.id&&(this.portalItem.portal||v.getDefault());return r&&s&&!d(s.restUrl,r.restUrl)?(t.messages&&t.messages.push(new o(\"layer:cross-portal\",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(e,{...t,layer:this})}};return e([h({type:P})],E.prototype,\"portalItem\",null),e([f(\"web-document\",\"portalItem\",[\"itemId\"])],E.prototype,\"readPortalItem\",null),e([y(\"web-document\",\"portalItem\",{itemId:{type:String}})],E.prototype,\"writePortalItem\",null),e([h({clonable:!1})],E.prototype,\"resourceReferences\",void 0),e([h({type:Boolean,readOnly:!0})],E.prototype,\"userHasEditingPrivileges\",void 0),e([h({type:Boolean,readOnly:!0})],E.prototype,\"userHasFullEditingPrivileges\",void 0),e([h({type:Boolean,readOnly:!0})],E.prototype,\"userHasUpdateItemPrivileges\",void 0),E=e([g(\"esri.layers.mixins.PortalLayer\")],E),E},_={credential:null,user:null};export{j as PortalLayer};\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAI+mC,IAAM,IAAE,CAAAA,OAAG;AAAC,MAAI,IAAE,cAAcA,GAAC;AAAA,IAAC,cAAa;AAAC,YAAM,GAAG,SAAS,GAAE,KAAK,qBAAmB,EAAC,YAAW,MAAK,OAAM,CAAC,EAAC,GAAE,KAAK,2BAAyB,MAAG,KAAK,+BAA6B,OAAG,KAAK,8BAA4B;AAAA,IAAE;AAAA,IAAC,UAAS;AAAC,WAAK,aAAW,EAAE,KAAK,UAAU,GAAE,KAAK,mBAAmB,aAAW,MAAK,KAAK,mBAAmB,MAAM,SAAO;AAAA,IAAC;AAAA,IAAC,IAAI,WAAW,GAAE;AAAC,YAAI,KAAK,KAAK,YAAY,MAAI,KAAK,aAAa,aAAa,GAAE,KAAK,KAAK,cAAa,CAAC;AAAA,IAAE;AAAA,IAAC,eAAe,GAAE,GAAEC,IAAE;AAAC,UAAG,EAAE,OAAO,QAAO,IAAI,EAAE,EAAC,IAAG,EAAE,QAAO,QAAOA,IAAG,OAAM,CAAC;AAAA,IAAC;AAAA,IAAC,gBAAgB,GAAE,GAAE;AAAC,SAAG,OAAK,EAAE,SAAO,EAAE;AAAA,IAAG;AAAA,IAAC,MAAM,eAAe,GAAE,GAAE;AAAC,UAAG,KAAK,YAAY,GAAG,KAAG;AAAC,cAAK,EAAC,MAAKA,GAAC,IAAE,MAAM,OAAO,4BAAsC;AAAE,eAAOC,GAAE,CAAC,GAAE,MAAMD,GAAE,EAAC,UAAS,MAAK,gBAAe,EAAE,gBAAe,cAAa,EAAE,cAAa,cAAa,EAAE,cAAa,oBAAmB,EAAE,oBAAmB,oBAAmB,EAAE,mBAAkB,GAAE,CAAC;AAAA,MAAC,SAAOA,IAAE;AAAC,cAAM,EAAEA,EAAC,KAAG,EAAE,UAAU,IAAI,EAAE,KAAK,yBAAyB,KAAK,KAAK,KAAK,KAAK,EAAE,kBAAkB,KAAK,WAAW,EAAE;AAAA,IAAQA,EAAC,EAAE,GAAEA;AAAA,MAAC;AAAA,IAAC;AAAA,IAAC,MAAM,8BAA8B,GAAE;AAAC,WAAK,KAAK,4BAA2B,MAAM,KAAK,+BAA+B,CAAC,EAAE,MAAO,CAAAE,QAAIC,GAAED,EAAC,GAAE,KAAI,CAAC;AAAA,IAAC;AAAA,IAAC,MAAM,kBAAkB,GAAEF,IAAE;AAAC,UAAG,CAAC,EAAE,sBAAsB,QAAO,KAAK,8BAA8BA,EAAC;AAAE,UAAG,KAAK,IAAI,KAAG;AAAC,cAAK,EAAC,UAAS,EAAC,MAAK,GAAE,UAASC,GAAC,GAAE,SAAQ,EAAC,YAAWG,GAAC,EAAC,IAAE,MAAM,KAAK,qBAAqB,GAAEJ,EAAC;AAAE,aAAK,KAAK,4BAA2B,CAAC,GAAE,KAAK,KAAK,gCAA+BC,EAAC,GAAE,KAAK,KAAK,+BAA8BG,EAAC;AAAA,MAAC,SAAOH,IAAE;AAAC,QAAAE,GAAEF,EAAC;AAAA,MAAC;AAAA,IAAC;AAAA,IAAC,MAAM,qBAAqB,GAAE,GAAE;AAAC,UAAIA,KAAE,KAAK;AAAW,UAAG,CAAC,KAAG,CAACA,MAAG,CAACA,GAAE,UAAQA,GAAE,UAAU,QAAO,KAAK,6BAA6B,CAAC;AAAE,YAAMG,KAAE,CAACH,IAAG,eAAe,KAAK,GAAG,GAAEI,KAAE,MAAIJ,GAAE;AAAG,UAAGI,MAAGJ,GAAE,OAAO,KAAK,QAAO,KAAK,mBAAmBA,IAAEG,EAAC;AAAE,UAAID,IAAE;AAAE,UAAGE,GAAE,CAAAF,KAAEF,GAAE,OAAO;AAAA,UAAS,KAAG;AAAC,QAAAE,KAAE,MAAM,EAAE,KAAK,KAAI,CAAC;AAAA,MAAC,SAAOG,IAAE;AAAC,QAAAH,GAAEG,EAAC;AAAA,MAAC;AAAC,UAAG,CAACH,MAAG,CAAC,EAAEA,IAAEF,GAAE,OAAO,GAAG,EAAE,QAAO,KAAK,6BAA6B,CAAC;AAAE,UAAG;AAAC,cAAMC,KAAE,QAAM,IAAE,EAAE,SAAO;AAAK,YAAE,MAAMD,IAAG,cAAc,GAAGE,EAAC,YAAW,EAAC,QAAO,OAAG,QAAOD,GAAC,CAAC;AAAA,MAAE,SAAOI,IAAE;AAAC,QAAAH,GAAEG,EAAC;AAAA,MAAC;AAAC,YAAM,IAAE,MAAG,IAAE,OAAG,IAAE;AAAG,UAAG,CAAC,EAAE,QAAM,EAAC,UAAS,EAAC,MAAK,GAAE,UAAS,EAAC,GAAE,SAAQ,EAAC,YAAW,EAAC,EAAC;AAAE,UAAG;AAAC,YAAGD,KAAE,MAAMJ,GAAE,OAAO,KAAGA,KAAE,IAAI,EAAE,EAAC,IAAG,GAAE,QAAO,EAAC,KAAIE,GAAC,EAAC,CAAC,GAAE,MAAMF,GAAE,KAAK,CAAC,IAAGA,GAAE,OAAO,KAAK,QAAO,KAAK,mBAAmBA,IAAEG,EAAC;AAAA,MAAC,SAAOE,IAAE;AAAC,QAAAH,GAAEG,EAAC;AAAA,MAAC;AAAC,aAAM,EAAC,UAAS,EAAC,MAAK,GAAE,UAAS,EAAC,GAAE,SAAQ,EAAC,YAAW,EAAC,EAAC;AAAA,IAAC;AAAA,IAAC,mBAAmB,GAAE,GAAE;AAAC,YAAMN,KAAE,EAAE,CAAC;AAAE,aAAO,MAAIA,GAAE,SAAS,OAAK,OAAIA;AAAA,IAAC;AAAA,IAAC,MAAM,6BAA6B,GAAE;AAAC,UAAI,IAAE;AAAG,UAAG;AAAC,YAAE,MAAM,KAAK,+BAA+B,CAAC;AAAA,MAAC,SAAOA,IAAE;AAAC,QAAAG,GAAEH,EAAC;AAAA,MAAC;AAAC,aAAM,EAAC,UAAS,EAAC,MAAK,GAAE,UAAS,MAAE,GAAE,SAAQ,EAAC,YAAW,MAAE,EAAC;AAAA,IAAC;AAAA,IAAC,MAAM,+BAA+B,GAAE;AAAC,YAAM,IAAE,KAAK,MAAIC,IAAG,eAAe,KAAK,GAAG,IAAE;AAAK,UAAG,CAAC,EAAE,QAAM;AAAG,YAAMA,KAAEM,GAAE,eAAa,IAAEA,GAAE,OAAK,MAAM,KAAK,kBAAkB,CAAC;AAAE,aAAOA,GAAE,aAAW,GAAEA,GAAE,OAAKN,IAAE,QAAMA,IAAG,cAAYA,GAAE,WAAW,SAAS,oBAAoB;AAAA,IAAC;AAAA,IAAC,MAAM,kBAAkB,GAAE;AAAC,YAAM,IAAE,KAAK,YAAY,QAAQ;AAAK,UAAG,EAAE,QAAO;AAAE,YAAMI,KAAEJ,IAAG,eAAe,KAAK,OAAK,EAAE;AAAE,UAAG,CAACI,IAAG,gBAAgB,QAAO;AAAK,YAAMF,KAAE,GAAGE,GAAE,eAAe,iBAAgB,IAAE,EAAE,WAAW;AAAE,UAAG,KAAG,EAAE,UAAQ,EAAE,EAAE,OAAO,MAAI,EAAEF,EAAC,EAAE,QAAO,EAAE;AAAK,YAAM,IAAE,GAAGA,EAAC,mBAAkB,IAAE,QAAM,IAAE,EAAE,SAAO,MAAKK,KAAE,MAAM,EAAE,EAAE,GAAE,EAAC,UAAS,aAAY,OAAM,EAAC,GAAE,OAAM,GAAE,QAAO,EAAC,CAAC,CAAC;AAAE,aAAOA,GAAE,KAAGA,GAAE,SAASA,GAAE,MAAM,IAAI,IAAE;AAAA,IAAI;AAAA,IAAC,KAAK,GAAE,GAAE;AAAC,YAAI,EAAE,QAAM,OAAM,MAAM,KAAK,GAAE,CAAC;AAAA,IAAC;AAAA,IAAC,MAAM,GAAE,GAAE;AAAC,YAAMR,KAAE,GAAG,QAAOC,KAAE,KAAK,YAAY,OAAK,KAAK,WAAW,UAAQ,EAAE,WAAW;AAAG,aAAOD,MAAGC,MAAG,CAAC,EAAEA,GAAE,SAAQD,GAAE,OAAO,KAAG,EAAE,YAAU,EAAE,SAAS,KAAK,IAAIC,GAAE,sBAAqB,cAAc,KAAK,KAAK,KAAK,KAAK,EAAE,iNAAgN,EAAC,OAAM,KAAI,CAAC,CAAC,GAAE,QAAM,MAAM,MAAM,GAAE,EAAC,GAAG,GAAE,OAAM,KAAI,CAAC;AAAA,IAAC;AAAA,EAAC;AAAE,SAAO,EAAE,CAAC,EAAE,EAAC,MAAK,EAAC,CAAC,CAAC,GAAE,EAAE,WAAU,cAAa,IAAI,GAAE,EAAE,CAAC,EAAE,gBAAe,cAAa,CAAC,QAAQ,CAAC,CAAC,GAAE,EAAE,WAAU,kBAAiB,IAAI,GAAE,EAAE,CAACD,GAAE,gBAAe,cAAa,EAAC,QAAO,EAAC,MAAK,OAAM,EAAC,CAAC,CAAC,GAAE,EAAE,WAAU,mBAAkB,IAAI,GAAE,EAAE,CAAC,EAAE,EAAC,UAAS,MAAE,CAAC,CAAC,GAAE,EAAE,WAAU,sBAAqB,MAAM,GAAE,EAAE,CAAC,EAAE,EAAC,MAAK,SAAQ,UAAS,KAAE,CAAC,CAAC,GAAE,EAAE,WAAU,4BAA2B,MAAM,GAAE,EAAE,CAAC,EAAE,EAAC,MAAK,SAAQ,UAAS,KAAE,CAAC,CAAC,GAAE,EAAE,WAAU,gCAA+B,MAAM,GAAE,EAAE,CAAC,EAAE,EAAC,MAAK,SAAQ,UAAS,KAAE,CAAC,CAAC,GAAE,EAAE,WAAU,+BAA8B,MAAM,GAAE,IAAE,EAAE,CAAC,EAAE,gCAAgC,CAAC,GAAE,CAAC,GAAE;AAAC;AAA1xI,IAA4xIO,KAAE,EAAC,YAAW,MAAK,MAAK,KAAI;",
  "names": ["j", "r", "s", "e", "a", "i", "o", "m", "_", "u"]
}
