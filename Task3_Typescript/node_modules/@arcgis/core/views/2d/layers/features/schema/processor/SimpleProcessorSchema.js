/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{pt2px as e}from"../../../../../../core/screenUtils.js";import r from"../../../../../../layers/support/OrderByInfo.js";import{TechniqueType as t}from"../../../../engine/webgl/shaderGraph/techniques/TechniqueType.js";import{createLabelMatcherSchema as s}from"./LabelMatcherSchema.js";import{createMatcherSchema as i}from"./MatcherSchema.js";import{createStorageSchema as n,createTrackStorageSchema as a}from"./StorageSchema.js";import{createVisualVariableUniforms as l}from"./VisualVariablesSchema.js";async function o(e,r){const t=r.renderer,n=l(t);return{symbology:await i(e,t),labels:await s(e,r,n)}}async function u(e,r,t,s){const i=t.featureReduction;if(i)switch(i.type){case"binning":return f(i,e,r,t,s);case"cluster":return p(i,e,r,t,s)}if(t.trackInfo?.enabled)return d(t.trackInfo,e,r,t,s);const a=b(t.orderBy,t.renderer,t.objectIdField),l=n(t.renderer,r.filters),u=await o(e,t),c=g(u.symbology);return{storage:l,mesh:{properties:{sortKey:a,timeZone:r.timeZone,returnMeshObjectId:c,displayRefreshVersion:s,currentUser:r.currentUser},strategy:{type:"feature"},factory:u},expressionProperties:{timeExtent:r.timeExtent?.toJSON()}}}function c(e,r){return e.fields.map((e=>({...e.toJSON(),type:y(e,r)})))}function y(e,r){const{onStatisticExpression:t,onStatisticField:s,statisticType:i}=e;switch(i){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find((e=>e.name===s));return e?e.type:"esriFieldTypeString"}}}async function f(r,t,a,o,u){const y=c(r,o.fields),f=r.renderer,p=await i(t,f),d=n(f,[null,null]),b=l(f),m=await s(t,{geometryType:"polygon",layerId:o.layerId,labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},b),v=g(p),h="geohash"===r.binType?{type:"geohash",fixBinLevel:r.fixedBinLevel??3}:{type:"grid",size:e(r.size),fixedBinLevel:r.fixedBinLevel};return{storage:d,mesh:{properties:{sortKey:null,timeZone:a.timeZone,returnMeshObjectId:v,displayRefreshVersion:u,currentUser:a.currentUser},strategy:{type:"binning",fields:y,index:h,featureFilter:a.filters[0]},factory:{labels:m,symbology:p}},expressionProperties:{timeExtent:a.timeExtent?.toJSON()}}}async function p(r,t,a,o,u){const y=c(r,o.fields),f={type:"cluster",feature:await i(t,r.effectiveFeatureRenderer),cluster:await i(t,r.effectiveClusterRenderer)},p=l(r.effectiveFeatureRenderer),d={type:"cluster",feature:await s(t,o,p),cluster:await s(t,{geometryType:"point",layerId:o.layerId,labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},p)},b=n(r.effectiveFeatureRenderer,[null,null]),m=g(f);return{storage:b,mesh:{properties:{sortKey:null,timeZone:a.timeZone,displayRefreshVersion:u,returnMeshObjectId:m,currentUser:a.currentUser},strategy:{type:"cluster",fields:y,featureFilter:a.filters[0],clusterRadius:e(r.clusterRadius/2)},factory:{labels:d,symbology:f}},expressionProperties:{timeExtent:a.timeExtent?.toJSON()}}}async function d(e,r,t,n,o){const u=c(e,n.fields),y={type:"track",previousObservation:await i(r,e.previousObservations.renderer),latestObservation:await i(r,e.latestObservations.renderer),trackLine:await i(r,e.trackLines.renderer)},f={type:"track",previousObservation:await s(r,{geometryType:n.geometryType,layerId:n.layerId,labelingInfo:e.previousObservations.labelingInfo,labelsVisible:e.previousObservations.labelsVisible},l(e.previousObservations.renderer)),latestObservation:await s(r,{geometryType:n.geometryType,layerId:n.layerId,labelingInfo:e.latestObservations.labelingInfo,labelsVisible:e.latestObservations.labelsVisible},l(e.latestObservations.renderer)),trackLine:await s(r,{geometryType:"polyline",layerId:n.layerId,labelingInfo:e.trackLines.labelingInfo,labelsVisible:e.trackLines.labelsVisible},l(e.trackLines.renderer))},p=a(e,[null,null]),d=g(y);return{storage:p,mesh:{properties:{sortKey:null,timeZone:t.timeZone,returnMeshObjectId:d,displayRefreshVersion:o,currentUser:t.currentUser},strategy:{type:"track",featureFilter:t.filters[0],fields:u,maxDisplayDuration:e.maxDisplayDuration?.toMilliseconds()??0,maxDisplayObservationsPerTrack:e.maxDisplayObservationsPerTrack,showLatestObservation:e.latestObservations.visible,showPreviousObservations:e.previousObservations.visible,showTrackLine:e.trackLines.visible,timeField:e.timeField},factory:{labels:f,symbology:y}},expressionProperties:{timeExtent:t.timeExtent?.toJSON()}}}function b(e,t,s){const i=null!=t&&"unique-value"===t.type&&t.orderByClassesEnabled;if("default"!==e||i||(e=[new r({field:s,order:"descending"})]),"default"!==e&&e?.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}if(i){return{byRenderer:!0,order:"asc"}}return null}function m(e){return e.techniqueType===t.AnimatedMarker}function g(e){if("simple"===e.type&&e.meshes.some(m))return!0;if("interval"===e.type){if(e.intervals.some((e=>e.meshes.some(m))))return!0;if(e.backgroundFill.some(m))return!0}if("map"===e.type){if(e.map.some((e=>e.symbol.some(m))))return!0;if(e.backgroundFill.some(m))return!0}return!1}export{u as createSimpleProcessorSchema,c as getAggregateFields};
